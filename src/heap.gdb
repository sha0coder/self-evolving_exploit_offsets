set confirm off
set breakpoint pending on
set disassembly-flavor intel
set follow-fork-mode child
set pagination off
set logging on

unset env LINES
unset env COLUMNS


# CHANGE THIS
file /home/vagrant/CVE-2021-3156-main/sudo-hax-me-a-sandwich


b nss_load_library
commands
    set $lib_count = $lib_count + 1
    printf ">>> ni->name  addr: 0x%x value: %s\n", ni->name, ni->name
    set $lib_addr = ni->name
    if $lib_count >= 10
        print ">>> distance: %d\n", ($lib_addr - $user_args_addr)
        q
    end
    c
end

b /home/vagrant/sudo-1.8.31/plugins/sudoers/sudoers.c:854
commands
    set $user_args_addr = size
    printf ">>> user_args size: %d\n", size
    q
end




b __GI___libc_free
commands
    if $rdi != 0
        printf ">>> free sz: %d addr: 0x%x content:%s\n", *($rdi-8), $rdi, $rdi
    end
    c
end

set $malloc_sz = 0
b malloc
commands
        set $malloc_sz = $rdi
        b *(*(long long *)$rsp)
        commands
                printf ">>> malloc addr: 0x%x sz:%d\n", $rax, $malloc_sz
                del 5-1000
                c
        end
        c
end



r 1

